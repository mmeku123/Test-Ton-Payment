<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Telegram Mini App Game</title>
    <!-- Include the Telegram Web App JavaScript API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <h1>My Game</h1>
    <p>Play the game and buy items using Telegram Stars!</p>
    <button id="buyItemButton">Buy Item with Stars</button>
    <!-- Button to buy an in-game item -->
    <div id="paymentStatus"></div>
    <!-- Status Display -->

    <script>
      const tg = window.Telegram.WebApp; // Initialize the Telegram Web App

      // Set up the "Buy Item" button click event
      document.getElementById("buyItemButton").addEventListener("click", () => {
        console.log("click");
        tg.MainButton.text = "Processing Payment...";
        tg.MainButton.show();
        requestStarsPayment();
      });

      function requestStarsPayment() {
        // Example invoice data for Stars payment
        const invoiceData = {
          chat_id: tg.initDataUnsafe.user.id, // User ID from Telegram init data
          title: "Game Item Purchase",
          description: "Purchase a game item using Telegram Stars.",
          payload: "game-item-purchase", // Unique identifier for the transaction
          currency: "XTR", // Use 'XTR' for Telegram Stars currency
          prices: [{ label: "Game Item", amount: 1000 }], // Example price in smallest currency unit (1 XTR = 100 units)
          start_parameter: "buy_game_item",
        };

        // Send a request to your server to initiate the payment process
        fetch(
          "https://ec41-2001-fb1-db-5759-3c54-3158-75fa-1875.ngrok-free.app/pay",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(invoiceData),
          }
        )
          .then((response) => response.json())
          .then((result) => {
            if (result.ok) {
              tg.MainButton.text = "Payment Successful!";
              document.getElementById("paymentStatus").innerText =
                "Item purchased successfully!";
            } else {
              tg.MainButton.text = "Payment Failed!";
              document.getElementById("paymentStatus").innerText =
                "Payment failed. Please try again.";
            }
            tg.MainButton.show();
          })
          .catch((error) => {
            tg.MainButton.text = "Payment Error!";
            tg.MainButton.show();
            console.error("Error processing payment:", error);
          });
      }
    </script>
  </body>
</html>
